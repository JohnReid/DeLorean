---
title: DeLorean analysis of Kouno et al. THP-1 human myeloid monocytic leukemia data
author: John Reid
bibliography: DeLorean.bib
output: html_document
---

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{DeLorean analysis of THP-1 human myeloid monocytic leukemia data}
-->


```{r config, echo=FALSE, message=FALSE}
library(knitr)
library(knitcitations)
library(rmarkdown)
#
# knitr options
#
opts_chunk$set(
    fig.path = 'figures/Kouno-',
    stop_on_error = TRUE,
    fig.width = 12.5,
    fig.height = 8)
#
# Citations
#
cleanbib()
cite_options(
    # hyperlink = 'to.doc',
    hyperlink = TRUE,
    # style = 'html',
    # citation_format = 'text',
    citation_format = "pandoc",
    cite.style = "numeric",
    check.entries = TRUE)
    # hyperlink = TRUE)
bib <- read.bibtex("DeLorean.bib")

```

```{r build, echo=FALSE, eval=FALSE}
library(devtools)
library(rmarkdown)
load_all('..')
render('DeLorean-Kouno.Rmd')

```

```{r loadLibs, echo=FALSE, message=FALSE}
# suppressMessages(loadfonts())
library(DeLorean)
#
# Stylesheet
#
options(markdown.HTML.stylesheet = system.file("inst/Rmd/foghorn.css",
                                               package="DeLorean"))

```

```{r}
font.family <- "Verdana"
font.theme <- theme_update(text=element_text(family=font.family))
theme_set(font.theme)

```



`r citet(bib[["kouno_temporal_2013"]])` assayed 120 single cells at each
of 8 time points.


# Data

Kouno et al.'s data is available in the `DeLorean` R package.
```{r loadLib}
library(DeLorean)
data(KounoDeLorean)

```


This will load a 45 (genes) by 960 (cells) matrix containing the expression
measurements.
```{r exprDim}
dim(kouno.expr)
```
and two data frames of meta data for the genes and cells.
```{r meta}
summary(kouno.gene.meta)
summary(kouno.cell.meta)
```


# Estimate hyperparameters

Examine data for empirical Bayes estimation of hyperparameters.
```{r empiricalBayes}
dl <- de.lorean(
    kouno.expr,
    kouno.gene.meta,
    kouno.cell.meta)
dl <- estimate.hyper(
    dl,
    sigma.tau=12,
    delta=.5)
# knit.report(dl, "hyper-parameters")

```


# Choose genes and cells

Choose a few cells from each stage.
```{r filterCells}
set.seed(1)
num.at.each.stage <- 7
sampled.cells <- (
    dl$cell.meta
    %>% group_by(capture)
    %>% do(sample_n(., num.at.each.stage))
)
cell.filter <- function(cells) cells %in% sampled.cells$cell
dl <- filter.cells(dl, cell.filter)
```


Format the data for Stan and fit the model.
```{r fitModel}
dl <- format.for.stan(dl)
dl <- compile.model.simple(dl)
dl <- find.best.tau(dl)
system.time(dl <- fit.model(dl))
```


Examine the model fit and plot the profiles.
```{r examineFit}
dl <- examine.convergence(dl)
dl <- process.posterior(dl)
dl <- analyse.noise.levels(dl)
dl <- make.predictions(dl)
gp <- plot(dl, type="best.predictions")
print(gp)

```


```{r echo=FALSE}
# Save DeLorean object without fit component
saveRDS({dl2 <- dl; dl2$fit <- NULL; dl2}, "Kouno.rds")
```


R version and packages used:
```{r Rversion}
sessionInfo()
```
