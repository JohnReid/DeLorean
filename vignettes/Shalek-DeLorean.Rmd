---
title: DeLorean analysis of Shalek et al. primary mouse bone-marrow-derived dendritic cells data
author: John Reid
bibliography: DeLorean.bib
output: html_document
---

```{r build, echo=FALSE, eval=FALSE}
library(devtools)
load_all('..')
library(rmarkdown)
fit.model <- FALSE
fit.model <- TRUE
render('Shalek-DeLorean.Rmd')

```

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{DeLorean analysis of Shalek et al. primary mouse bone-marrow-derived dendritic cells data}
-->


```{r config, echo=FALSE, message=FALSE}
library(knitr)
library(knitcitations)
library(rmarkdown)
library(functional)
#
# knitr options
#
opts_chunk$set(
    fig.path = 'figures/Shalek-',
    stop_on_error = TRUE,
    fig.width = 12.5,
    fig.height = 8)
#
# Citations
#
cleanbib()
cite_options(
    # hyperlink = 'to.doc',
    hyperlink = TRUE,
    # style = 'html',
    # citation_format = 'text',
    citation_format = "pandoc",
    cite.style = "numeric",
    check.entries = TRUE)
    # hyperlink = TRUE)
bib <- read.bibtex("DeLorean.bib")
if (file.exists("config.R")) {
    source("config.R")
}
#
# Widths for saving figures
#
text.width <- 4.79  # LaTeX width in inches
golden.ratio <- 1.618  # Pleasing ratio
fig.width <- text.width
fig.height <- text.width / golden.ratio

```

```{r loadLibs, echo=FALSE, message=FALSE}
# suppressMessages(loadfonts())
library(DeLorean)
#
# Stylesheet
#
options(markdown.HTML.stylesheet = system.file("inst/Rmd/foghorn.css",
                                               package="DeLorean"))
font.family <- "Verdana"
font.theme <- theme_update(text=element_text(family=font.family))
theme_set(font.theme)

```

`r date()`



# Data

Shalek et al.'s data `r citet(bib[["shalek_single-cell_2014"]])`
is available in the `DeLorean` R package.
```{r loadLib, eval=fit.model}
library(DeLorean)
data(ShalekDeLorean)

```


Build the `DeLorean` object.
```{r buildDL, eval=fit.model}
dl <- de.lorean(
    shalek.A.expr,
    shalek.A.gene.meta,
    shalek.A.cell.meta)

```


Filter out the cells we want for the time course.
```{r filterTimeCourse, eval=fit.model}
time.course.cells <- (
    dl$cell.meta
    %>% filter(! is.na(total),
               "" == assay,
               "LPS" == stimulant | "" == stimulant,
               "" == ko,
               FALSE == disrupted,
               total > 1e6,
               "" == replicate))
dl <- filter.cells(dl, function(cells) cells %in% time.course.cells$cell)

```


Re-level the cells by their capture time. This improves the ordering in later
plots.
```{r relevelCells}
dl$cell.meta$cell <- factor(
    dl$cell.meta$cell,
    levels=(shalek.A.cell.meta %>% arrange(capture))$cell)

```


Only use induced genes that have been assigned to a cluster.
```{r useInducedGenes, eval=fit.model}
induced.genes <- dl$gene.meta %>% filter(! is.na(cluster))
dl <- filter.genes(dl, function(genes) genes %in% induced.genes$gene)

```
```{r child=report.file("data")}
```




# Estimate hyperparameters

Examine data for empirical Bayes estimation of hyperparameters.
```{r empiricalBayes, eval=fit.model}
dl <- estimate.hyper(
    dl,
    sigma.tau=2,
    delta=.5,
    length.scale=5,
    model.name='simple-model')

```
```{r child=report.file("hyper-parameters")}
```


# Choose genes and cells

Choose genes: take those with highest variance between time points
relative to the noise level.
```{r filterGenes, eval=fit.model}
max.genes <- min(getOption("Shalek.max.genes", 74))
shalek.key.genes <- unique(toupper(c(
    #
    # Cluster I d (core antiviral module; enriched for annotated antiviral and
    #             interferon response genes; for example,-
    "Ifit1", "Irf7",
    #
    # Cluster III c (peaked inflammatory module; showing rapid,
    # yet transient, induction under LPS; for example,
    "Tnf", "Il1a", "Cxcl2",
    #
    # Cluster III d (sustained inflammatory module; exhibiting
    # continued rise in expression under LPS; for example,
    "Mmp14", "Marco", "Il6",
    #
    # Cluster III b (‘maturity’ module; containing markers of
    # dendritic cell maturation; for example,
    "Cd83", "Ccr7", "Ccl22",
    #
    # At 2 h following LPS,
    "Ifnb1",
    # was bimodally expressed
    #
    # Genes encoding key inflammatory cytokines (for example,
    "Tnf", "Cxcl1",
    #
    # Figure 4: core antiviral targets.
    "Rsad2", "Stat2"
)))
clusters <- c("Id", "IIIb", "IIIc", "IIId")
# clusters <- c("Id")
genes.for.stan <- (
    dl$gene.var
    %>% left_join(dl$gene.meta)
    %>% mutate(key=gene %in% shalek.key.genes)
    %>% filter(cluster %in% clusters)
    %>% arrange(- psi.bar + omega.bar)
    %>% head(max.genes))
dl <- filter.genes(dl, function(genes) genes %in% genes.for.stan$gene)
# How many come from each cluster?
qplot(genes.for.stan$cluster)

```

Choose a few cells but make sure we have the precocious cells.
```{r filterCells, eval=fit.model}
set.seed(1)
num.cells <- getOption("Shalek.max.cells", 75)
sampled.cells <- sample(colnames(dl$expr), num.cells)
if (! "LPS_1h_S51" %in% sampled.cells) {
    sampled.cells[1] <- "LPS_1h_S51"
}
if (! "LPS_1h_S52" %in% sampled.cells) {
    sampled.cells[2] <- "LPS_1h_S52"
}
dl <- filter.cells(dl, function(cells) cells %in% sampled.cells)

```


Save expression data and meta data.
```{r saveInput, eval=fit.model}
saveRDS(list(expr = dl$expr, cell.meta = dl$cell.map, gene.meta=dl$gene.map),
        file='Shalek-input.rds')

```


Format the data for Stan and fit the model.
```{r fitModel, eval=fit.model}
dl <- format.for.stan(dl)
system.time(dl <- find.smooth.tau(dl, num.tau.to.try=detectCores()*2))
# system.time(dl <- find.smooth.tau(dl, num.cores=3, num.tau.to.try=8))
# system.time(dl <- find.smooth.tau(dl, num.tau.to.try=45))
dl <- compile.model(dl)

# library(devtools)
# load_all('..')
# test.dl <- readRDS(file='test-dl.rds')
# # orderings <- test.mh(test.dl, use.parallel=F)
# orderings <- test.mh(test.dl)
# orderings.list <- lapply(orderings, function(o) o$chain)

# set.seed(1)
# which.tau <- 4
# test.dl <- find.smooth.tau(dl, method="metropolis")
# saveRDS(test.dl, file='test-dl.rds')
# times <- data.frame(c=1:test.dl$stan.data$C,
                    # tau=test.dl$tau.inits[[which.tau]]$tau)
# expr.l <- with(test.dl,
    # expr
    # %>% melt(varnames=c("gene", "cell"), value.name="x")
    # %>% mutate(gene=factor(gene, levels=levels(gene.meta$gene)),
               # cell=factor(cell, levels=levels(cell.meta$cell)))
    # %>% left_join(test.dl$cell.map %>% select(cell, c, capture, obstime))
    # %>% left_join(times)
# )
# # qplot(x=times$tau, y=dl$stan.data$time)
# gp <- (ggplot(expr.l, aes(x=tau, y=x, color=capture))
    # + geom_point()
    # + geom_line(aes(color=NULL), alpha=.5)
    # + facet_wrap(~ gene))
# pdf('smoothed-tau.pdf', width=10)
# print(gp)
# dev.off()

system.time(dl <- fit.model(dl))

```


# Examine convergence.

```{r examConv}
dl <- examine.convergence(dl)
```
```{r child=report.file("convergence")}
```


# Analyse posterior

Examine posterior.
```{r posterior}
dl <- process.posterior(dl)
dl <- analyse.noise.levels(dl)

```
```{r child=report.file("posterior")}
```


# Profiles

Calculate expression profiles.
```{r makePredictions}
dl <- make.predictions(dl)
```
```{r child=report.file("profiles")}
```



Save DeLorean object.
```{r echo=FALSE}
# Remove large fit component
saveRDS({dl2 <- dl; dl2$fit <- NULL; dl2}, "Shalek.rds")
# dl <- readRDS("Shalek.rds")
```


```{r clusterAnalysis}
clustered <- dl$gene.meta %>% filter(! is.na(cluster))
clustered.expr <- shalek.A.expr[clustered$gene,time.course.cells$cell]
# rownames(clustered.expr)
# colnames(clustered.expr)
melt.expr <- function(dl, expr=dl$expr) {
    (
        expr
        %>% melt(varnames=c("gene", "cell"), value.name="x")
        %>% mutate(gene=factor(gene, levels=levels(dl$gene.meta[["gene"]])),
                   cell=factor(cell, levels=levels(dl$cell.meta[["cell"]])))
    )
}
clustered.expr.l <- (
    melt.expr(dl, clustered.expr)
    %>% left_join(dl$gene.meta))
names(clustered.expr.l)
# sample_n(clustered.expr.l, 14)
module.scores <- (
    clustered.expr.l
    %>% group_by(cluster, cell)
    %>% summarise(module.score=mean(x))
    %>% left_join(dl$samples.l$tau
                  %>% filter(dl$best.sample == iter)
                  %>% select(cell, tau)))
# Find the precocious cells
core.antiviral <- (
    module.scores
    %>% left_join(dl$cell.meta %>% select(cell, capture))
    %>% filter("Id" == cluster)
    %>% arrange(-module.score))
precocious <- core.antiviral %>% filter("1h" == capture) %>% head(2)
precocious
precocious$cell
module.scores <- module.scores %>% mutate(precocious=cell %in% precocious$cell)
(ggplot(core.antiviral, aes(x=module.score, color=capture)) + geom_density())
# Plot the core antiviral, the maturity, the peaked inflammation and
# the sustained inflammation module scores against pseudotime.
(ggplot(module.scores
        %>% filter(! is.na(tau),
                   cluster %in% c("Id", "IIIb", "IIIc", "IIId")),
        aes(x=tau, y=module.score, colour=cluster))
    + stat_smooth()
    + geom_point())
# Same with just core antiviral coloured by capture
(ggplot(module.scores
        %>% left_join(dl$cell.meta %>% select(cell, capture))
        %>% filter(! is.na(tau),
                   cluster == "Id"),
        aes(x=tau, y=module.score, colour=capture, shape=precocious))
    + stat_smooth(aes(group=""))
    + geom_point())

# Examine what pseudotimes the model estimated for the precocious genes
( dl$samples.l$tau
    %>% filter(dl$best.sample == iter,
               cell %in% precocious$cell))

```


```{r checkPrecocious}
S51.dists <- with(
    dl,
    melt(expr - expr[,"LPS_1h_S51"], varnames=c("gene", "cell"))
    %>% mutate(gene=factor(gene, levels=levels(gene.map$gene)))
    %>% mutate(cell=factor(cell, levels=levels(cell.map$cell)))
    %>% left_join(gene.map)
    %>% left_join(cell.map))
names(S51.dists)
# bad.genes <- c(51, 53, 73)
bad.genes <- c()
dl$gene.map[bad.genes,]
gp <- (
    ggplot(S51.dists %>% filter(! g %in% bad.genes),
           aes(x=g, y=c, fill=value))
    + geom_tile()
    + scale_fill_gradient2()
)
png('S51-dists.png', width=960, height=960)
print(gp)
dev.off()

```


Evaluate the held out genes that weren't used to fit the model. We fit GPs
to the data with two covariance functions. We use the same covariance
structure as the model.
$$
    \Sigma(c_1, c_2) = \mu_\bar{\psi} + \Sigma_t(c_1, c_2) + \mu_\bar{\omega}
$$
In one case we use the pseudotimes from the best sample for $\Sigma_t$. The
marginal likelihood from this model is a proxy for how well the pseudotimes
smooth the expression values.
$$
    \Sigma_t(c_1, c_2) = \Sigma_t(r=|\tau_{c_1} - \tau_{c_2}|)
$$
in the other case, we use the cell capture times. The marginal likelihood
for this model is a proxy for how well the expression values are smoothed
by the capture times.
$$
    \Sigma_t(c_1, c_2) = \Sigma_t(r=|\kappa_{c_1} - \kappa_{c_2}|)
$$
```{r heldOutGenes}
held.out.genes <- with(dl, gene.var
                           %>% left_join(gene.meta)
                           %>% filter(! gene %in% gene.map$gene)
                           %>% filter(cluster != "Id")
                           %>% arrange(-psi.bar)
                           %>% head(getOption('Shalek.held.out', 100)))
best.sample <- with(dl,
    samples.l$tau %>% filter(best.sample == iter)
    %>% left_join(samples.l$S %>% filter(best.sample == iter)))
held.out <- held.out.genes$gene[1]
#' Calculate covariance over pseudotimes and capture times
calc.K <- Curry(cov.calc.gene,
                dl,
                include.test=F,
                psi=dl$stan.data$mu_psi,
                omega=dl$stan.data$mu_omega)
K.tau <- calc.K(use.capture=FALSE)
K.capture <- calc.K(use.capture=TRUE)
#' Evaluate the held out gene under the GP model using pseudotimes
#' and a model without.
#'
evaluate.held.out <- function(dl, best.sample, held.out) {
    held.out.expr <- shalek.A.expr[held.out, dl$cell.map$cell] + best.sample$S
    c(
        gp.log.marg.like(held.out.expr, K.tau),
        gp.log.marg.like(held.out.expr, K.capture))
}
marg.lls <- sapply(held.out.genes$gene,
                   Curry(evaluate.held.out,
                         dl=dl,
                         best.sample=best.sample))
held.out.genes$marg.LL.tau <- marg.lls[1,]
held.out.genes$marg.LL.capture <- marg.lls[2,]
held.out.gp <- (
    ggplot(held.out.genes, aes(x=marg.LL.tau, y=marg.LL.capture, color=psi.bar))
    + geom_point()
    + scale_colour_gradient(high="red")
    + geom_abline(intercept=0, slope=1))
print(held.out.gp)
ggsave('Shalek-held-out.png', held.out.gp)
with(held.out.genes, t.test(marg.LL.tau, marg.LL.capture,
                            paired=TRUE, alternative="greater"))

```

```{r date}
date()
```


R version and packages used:
```{r Rversion}
sessionInfo()
```
