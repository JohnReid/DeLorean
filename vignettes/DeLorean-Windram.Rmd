---
title: DeLorean analysis of Windram et al. Arabidopsis time series
author: John Reid
bibliography: DeLorean.bib
output: html_document
---

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{DeLorean analysis of Arabidopsis time series}
-->

```{r build, echo=FALSE, eval=FALSE}
library(devtools)
load_all('..')
library(rmarkdown)
render('DeLorean-Windram.Rmd')

```


```{r config, echo=FALSE, message=FALSE}
library(knitr)
library(knitcitations)
library(rmarkdown)
#
# knitr options
#
opts_chunk$set(
    fig.path = 'figures/Windram-',
    stop_on_error = TRUE,
    fig.width = 12.5,
    fig.height = 8)
#
# Citations
#
cleanbib()
cite_options(
    # hyperlink = 'to.doc',
    hyperlink = TRUE,
    # style = 'html',
    # citation_format = 'text',
    citation_format = "pandoc",
    cite.style = "numeric",
    check.entries = TRUE)
    # hyperlink = TRUE)
bib <- read.bibtex("DeLorean.bib")
if (file.exists("config.R")) {
    source("config.R")
}
#
# Widths for saving figures
#
text.width <- 4.79  # LaTeX width in inches
golden.ratio <- 1.618  # Pleasing ratio
fig.width <- text.width
fig.height <- text.width / golden.ratio

```

```{r loadLibs, echo=FALSE, message=FALSE}
# suppressMessages(loadfonts())
library(DeLorean)
#
# Stylesheet
#
options(markdown.HTML.stylesheet = system.file("inst/Rmd/foghorn.css",
                                               package="DeLorean"))
font.family <- "Verdana"
font.theme <- theme_update(text=element_text(family=font.family))
theme_set(font.theme)

```


`r citet(bib[["windram_arabidopsis_2012"]])` assayed leaves at 24 time points
in 2 conditions.


# Data

Windram et al.'s data is available in the `DeLorean` R package.
```{r loadLib}
library(DeLorean)
data(WindramDeLorean)

```


## Obfuscate time points

Reduce resolution of observed capture time points.
```{r}
group.size <- 12
windram.cell.meta$obstime.orig <- windram.cell.meta$obstime
windram.cell.meta$capture.orig <- windram.cell.meta$capture
windram.cell.meta$obstime <- (
    floor((windram.cell.meta$obstime-1) / group.size) * group.size
    + group.size / 2)
windram.cell.meta$capture <- (
    factor(as.character(windram.cell.meta$obstime),
           ordered=TRUE,
           levels=unique(as.character(windram.cell.meta$obstime))))

```

Just consider the *Botrytis* cells and select some at random if we have
too many.
```{r}
set.seed(1)
dl <- de.lorean(
    windram.expr,
    windram.gene.meta,
    windram.cell.meta)
max.cells <- min(getOption("DL.max.cells", 24))
botrytis.cells <- sample(
    filter(dl$cell.meta, condition == "Botrytis")$cell,
    max.cells)
cell.filter <- function(cells) cells %in% botrytis.cells
dl <- filter.cells(dl, cell.filter)

```

```{r child=report.file("data")}
```


# Estimate hyperparameters

Examine data for empirical Bayes estimation of hyperparameters.
```{r empiricalBayes}
dl <- estimate.hyper(
    dl,
    sigma.tau=group.size / 2,
    delta=.5)

```

```{r child=report.file("hyper-parameters")}
```


# Choose genes

Choose a few genes.
```{r filterGenes}
max.genes <- min(getOption("DL.max.genes", 150))
sampled.genes <- sample_n(dl$gene.meta, max.genes)$gene
gene.filter <- function(genes) genes %in% sampled.genes
dl <- filter.genes(dl, gene.filter)

```


Format the data for Stan and fit the model.
```{r fitModel}
dl <- format.for.stan(dl)
dl <- compile.model.simple(dl)
dl <- find.best.tau(dl)
system.time(dl <- fit.model(dl, num.cores=getOption("DL.num.cores")))

```


# Examine convergence.

```{r examConv}
dl <- examine.convergence(dl)

```

```{r child=report.file("convergence")}
```



# Analyse posterior

Examine posterior.
```{r posterior}
dl <- process.posterior(dl)
dl <- analyse.noise.levels(dl)

```

```{r child=report.file("posterior")}
```


# Profiles

Calculate expression profiles.
```{r makePredictions}
dl <- make.predictions(dl)
```

```{r child=report.file("profiles")}
```


# Examine pseudotime

Did `DeLorean` learn the obfuscated pseudotime?
```{r pseudotime}
gp <- with(dl, {
    (ggplot(samples.l$tau %>% filter(iter == best.sample),
                    aes(x=tau, y=obstime.orig, color=capture),
                    environment=environment())
        + geom_point()
        + scale_x_continuous(name="pseudotime")
        + scale_y_continuous(name="true capture time")
    )
})
print(gp)
# png('pseudotime-vs-obfuscated.png')
pdf('Windram-pseudotime-vs-obfuscated.pdf', width=fig.width, height=fig.height)
print(gp)
dev.off()
# Save profiles as well
pdf('Windram-profiles.pdf', width=2*fig.width, height=2*fig.height)
plot(dl, type="best.predictions")
dev.off()
# Save tau posterior
pdf('Windram-tau-posterior.pdf', width=2*fig.width, height=2*fig.height)
(ggplot(dl$samples.l$tau, aes(x=capture.orig, y=tau, color=capture))
    + geom_boxplot()
    # + theme(axis.text.x = element_text(angle = 90, hjust = 1))
    + scale_x_discrete(name="true capture time")
    + scale_y_continuous(name="pseudotime")
    + scale_color_discrete(name="model\ncapture\ntime")
    + coord_flip())
dev.off()

```


Look at the expected correlation between the obfuscated capture time with the
pseudotime in the full posterior.
```{r}
posterior.cor <- (
    dl$samples.l$tau
    %>% group_by(iter)
    %>% summarise(pseudotime.capture.cor=cor(tau, obstime.orig))
)
mean(posterior.cor$pseudotime.capture.cor)
gp <- (ggplot(posterior.cor, aes(x=pseudotime.capture.cor))
    + geom_histogram()
    + scale_x_continuous(name="correlation"))
print(gp)
pdf('Windram-posterior-cor.pdf', width=fig.width, height=fig.height)
print(gp)
dev.off()

```


The correlation between the obfuscated capture time with the pseudotime of
the best sample.
```{r}
with(dl$samples.l$tau %>% filter(iter == dl$best.sample),
     cor(tau, obstime.orig))

```

```{r echo=FALSE}
# Save DeLorean object without fit component
saveRDS({dl2 <- dl; dl2$fit <- NULL; dl2}, "Windram.rds")
# dl <- readRDS("Windram.rds")

```


R version and packages used:
```{r Rversion}
date()
sessionInfo()
```
