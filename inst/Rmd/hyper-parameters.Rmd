
# Hyper-parameter estimation


We have expression data for $G$ genes and $C$ cells, $x_{g,c}$,
where $1\le g \le G$ and $1 \le c \le C$


# Cell size factors: S

First we calculate the mean expression for each gene, that is the average of
all those expression values that did not drop out.
$$
\mu_g = \textrm{Mean}_c (x_{g,c})
$$
which has this density:
```{r geneMean}
(ggplot(gene.expr, aes(x=x.mean)) + geom_density() + geom_rug())

```

Now we estimate the cell size factors
$$
\hat{S}_c = \text{Median}_g (x_{g,c} - \mu_g)
$$
which have this density (we show the empirical Bayes prior in dotted blue):
```{r cellSizeFactors}
(ggplot(cell.expr, aes(x=S.hat)) + geom_density() + geom_rug()
    + stat_function(fun=function(x) dnorm(x,
                                          mean=hyper$mu_S,
                                          sd=hyper$sigma_S),
                    colour="blue", alpha=.7, linetype="dashed")
)

```



## Expression variation: $\phi$, $\psi$, $\omega$

Given the estimated cell size factors, we can adjust our gene
measurements, accounting for the different cell sizes
$$
\hat{x}_{g,c} = x_{g,c} - \hat{S}_c
$$

Plot the adjusted s.d. against the unadjusted.
Hopefully the adjusted is lower in general.
```{r adjVsUnadj}
(ggplot(gene.expr,
        aes(x=x.sd, y=x.hat.sd))
    + geom_point()
    + geom_abline(intercept=0, slope=1, alpha=.4)
)

```

Is there a relationship between the adjusted s.d. and the mean?
The correlation is `r with(gene.expr, {cor(phi.hat, x.hat.sd)})`
```{r adjSDvsMean}
(ggplot(gene.expr,
        aes(x=phi.hat, y=x.hat.sd))
    + geom_point()
)

```

From these adjusted expression measurements, we can estimate the genes' means
$$
\hat{\mu}_g = \textrm{Mean}_c (\hat{x}_{g,c})
$$
which have this density:
```{r geneAdjMean}
(ggplot(gene.expr, aes(x=phi.hat)) + geom_density() + geom_rug()
    + stat_function(fun=function(x) dnorm(x,
                                          mean=hyper$mu_phi,
                                          sd=hyper$sigma_phi),
                    colour="blue", alpha=.7, linetype="dashed")
)

```

Having estimated the gene expression means, we can decompose the observed
variance.  We examine the variance both between and within time points. We
expect some of the variance within a time point to be associated with noise in
the temporal dimension, that is estimating the pseudotime correctly should
reduce the within time variance.

Let
$$
t_c \in \{\kappa_1, \dots, \kappa_T\}
$$
be the time point at which cell $c$ was captured. We partition the cells
by their captured time points indexed by $1 \le t \le T$:
$$
\mathcal{K}_t = \{c: t_c = \kappa_t\}
$$
We group the expression measurements by gene and observed time to
calculate means and variances:
$$
\begin{align}
\mu_{g,t} &= \text{Mean}(\{\hat{x}_{g,c}:z_{g,c} = 1, c \in \mathcal{K}_t\}) \\\\
\mathbb{V}_{g,t} &= \text{Var}(\{\hat{x}_{g,c}:z_{g,c} = 1, c \in \mathcal{K}_t\})
\end{align}
$$
The variances have this distribution:
```{r geneWithinVar}
(ggplot(gene.time.expr, aes(x=x.var)) + geom_density() + geom_rug())

```

Mean expression by time:
```{r geneTimeMean}
(ggplot(gene.time.expr,
        aes(x=x.mean, y=sqrt(x.var), color=capture))
    + geom_point(alpha=.4)
)

```


We estimate the gene variation between time as the variation of the within
time mean:
$$
\bar{\psi}_g = \text{Var}_t(\mu_{g,t})
$$
and the gene variation within time as the average of the variation
within the times:
$$
\bar{\omega}_g = \text{Mean}_t(\mathbb{V}_{g,t})
$$

Gene variation between and within time:
```{r geneVarBetweenWithin}
(ggplot(gene.var,
        aes(x=omega.bar,
            y=psi.bar))
    + geom_point(alpha=.5)
    + geom_rug(alpha=.05)
)

```

We expect some of the variance within a time point to be associated with noise
in the temporal dimension so we adjust the estimated between and within
time variances using a scaling factor $\delta$:
$$
\begin{align}
\hat{\psi}_g &= \bar{\psi}_g + \delta \bar{\omega}_g \\\\
\hat{\omega}_g &= \bar{\omega}_g - \delta \bar{\omega}_g
\end{align}
$$
giving these densities:

```{r geneVarBetweenWithinAdj}
(ggplot(gene.var, aes(x=psi.hat)) + geom_density() + geom_rug()
    + stat_function(fun=function(x) dlnorm(x,
                                           mean=hyper$mu_psi,
                                           sd=hyper$sigma_psi),
                    colour="blue", alpha=.7, linetype="dashed")
)
(ggplot(gene.var, aes(x=omega.hat)) + geom_density() + geom_rug()
    + stat_function(fun=function(x) dlnorm(x,
                                           mean=hyper$mu_omega,
                                           sd=hyper$sigma_omega),
                    colour="blue", alpha=.7, linetype="dashed")
)

```
