---
title: Fit low-rank branching model to Guo data
author: John Reid
output: pdf_document
---

```{r build, echo=FALSE, eval=FALSE}
devtools::load_all()
rmarkdown::render('Guo-branching-lowrank.Rmd')
```


Load libraries
```{r loadLibs, message=FALSE}
library(stringr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(ggthemes)
library(DeLorean)
```


```{r config, echo=FALSE, message=FALSE}
#
# Seed RNG
set.seed(1)
#
# Configure ggplot2
theme_set(theme_few())
scale_colour_discrete <- function(...) scale_colour_few(...)
scale_fill_discrete <- function(...) scale_fill_few(...)
#
# Configuration for knitr and rmarkdown
library(knitr)
library(rmarkdown)
#
# knitr options
opts_chunk$set(
  fig.path = 'figures/Guo-rand-',
  stop_on_error = TRUE,
  fig.width = 12.5,
  fig.height = 8)
#
# Widths for saving figures
text.width <- 4.79  # LaTeX width in inches
golden.ratio <- 1.618  # Pleasing ratio
fig.width <- text.width
fig.height <- text.width / golden.ratio
#
# Stylesheet
options(
  markdown.HTML.stylesheet = system.file("inst/Rmd/foghorn.css", package="DeLorean"))
font.family <- "Verdana"
font.theme <- theme_update(text=element_text(family=font.family))
theme_set(font.theme)
#
# Create directory for plots and list to store them
dir.create('Plots')
plots <- list()
```


# Load data
Load the data from the `DeLorean` package.
```{r load.test.data}
data(GuoDeLorean)
guo.expr.centred <- t(scale(t(guo.expr), scale=FALSE, center=TRUE))
guo.cell.meta <-
  guo.cell.meta %>%
  mutate(cell.type = factor(ifelse(is.na(cell.type), "NA", as.character(cell.type))))
```


# Fit DeLorean model

Create DeLorean object.
```{r createDL}
dl <- de.lorean(
  guo.expr.centred,
  guo.gene.meta,
  guo.cell.meta)
```


## PCA
Perform a PCA on the expression data and calculate which direction in PC1-PC2 space best
correlates with capture time.
```{r pcaPkg}
dl <- pca.expr(dl)
```

Project the cells onto PC1 and PC2. Show the direction that best reflects capture time.
```{r}
plots$PCA <-
  ggplot(dl$pca.df, aes(x = PC1, y = PC2, label = cell, colour = capture, shape = cell.type)) +
  geom_point(size = 4) +
  geom_abline(slope = dl$capturetime.slope)
plots$PCA
```

Project the cells onto PC1 and PC2 coloured by the z estimates
```{r}
plots[['PCA-z']] <-
  ggplot(dl$pca.df, aes(x = PC1, y = PC2, colour = z.hat)) +
  geom_point(size = 4) +
  geom_abline(slope = dl$capturetime.slope) +
  scale_colour_gradient2()
plots[['PCA-z']]
```


## Estimate hyperparameters
```{r empiricalBayes}
model.name <- 'branching'
dl <- estimate.hyper(dl, sigma.tau = .25, model.name = model.name, adjust.cell.sizes = FALSE)
```

Choose a few cells from each capture time
```{r chooseCells}
guo.cell.meta %>%
  group_by(capture) %>%
  summarise(number = n())
filter.cells <- TRUE
if (filter.cells) {
  # n.sample <- 157
  n.sample <- 17
  sampled.cells <- guo.cell.meta %>%
    group_by(capture) %>%
    do(sample_n(., min(nrow(.), n.sample)))
  sampled.cells %>% summarise(number = n())
  dl <- filter.cells(dl, cells=sampled.cells$cell)
}
```


## Fit
```{r fit}
dl <- prepare.for.stan(dl)
dl <- compile.model(dl)
dl <- fit.model(dl, method = 'vb', num.cores = 1)
# dl <- fit.model(dl, method = 'sample', num.cores = 2, iter = 100)
dl <- process.posterior(dl)
dl <- analyse.noise.levels(dl)
```

```{r shinyStan, eval = FALSE, echo = FALSE}
#
# Examine with ShinyStan
#
my_sso <- shinystan::launch_shinystan(fit)
```


## Locations in latent space
Plot tau vs. z from the best sample.
```{r plotTauZ}
plots[['tau.z']] <- branching.tau.z.plot(dl)
plots[['tau.z']]
```


## Gene noise and temporal variances
Plot the posterior for the noise and temporal variance levels
```{r postNoise}
plots$var <- plot(dl, type = 'gene.params')
plots$var
```


## Predicted expression
Calculate and plot the predicted expression for randomly selected genes across the latent space.
```{r predictExpr}
dl <- branching.prepare.posterior(dl)
genes.post <- branching.genes.post(dl, sample(dl$gene.map$gene, 9))
plots$gex <- branching.post.plot(dl, genes.post)
plots$gex
```


```{r savePlots, echo = FALSE}
save_plot <- function(name) {
  filename <- str_c('Plots/Guo-', name, '.pdf')
  message('Saving: ', filename)
  ggsave(
    filename,
    plots[[name]],
    width = 12,
    height = 8,
    units = 'in')
  filename
}
invisible(lapply(names(plots), save_plot))
```


# Session information
R version and packages used:
```{r Rversion}
date()
devtools::session_info()
```
